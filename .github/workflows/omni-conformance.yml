name: Omni Conformance Gate

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  omni-conformance-gate:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Omni Version
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $pluginPath = "Plugins/Omni/Omni.uplugin"
          $plugin = Get-Content -Raw $pluginPath | ConvertFrom-Json
          $version = [string]$plugin.VersionName

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Omni Version"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- VersionName: $version"

          if ($version -ne "0.1.0") {
            throw "Unexpected Omni version '$version'. Expected '0.1.0'."
          }

      - name: Run Omni Conformance Gate
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $logPath = Join-Path $env:RUNNER_TEMP "omni_conformance_gate.log"
          $shellCommand = Get-Command pwsh -ErrorAction SilentlyContinue
          if (-not $shellCommand) {
            $shellCommand = Get-Command powershell -ErrorAction Stop
          }

          & $shellCommand.Source -NoLogo -NoProfile -ExecutionPolicy Bypass -File .\Scripts\omni_conformance_gate.ps1 2>&1 | Tee-Object -FilePath $logPath
          $exitCode = $LASTEXITCODE
          if ($null -eq $exitCode) {
            $exitCode = if ($?) { 0 } else { 1 }
          }

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## Omni Conformance Gate"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "```text"
          if (Test-Path $logPath) {
            Get-Content -Path $logPath | ForEach-Object { Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $_ }
          } else {
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "Conformance log file was not generated."
          }
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "```"

          if ($exitCode -ne 0) {
            exit $exitCode
          }
